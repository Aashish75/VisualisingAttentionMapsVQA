<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attention Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: #007bff;
            margin-bottom: 20px;
        }
        .container {
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .image-display {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .dropdown {
            width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }
        select, button {
            width: 48%;
            padding: 8px;
            font-size: 1rem;
            border-radius: 4px;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        .result {
            width: 100%;
            margin-top: 20px;
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Visualising Attention Maps as Evidence for Visual Question Answering</h1>
    <div class="container">
        <!-- Display Default or Uploaded Image -->
        <img src="default-image.jpg" alt="Default Image" id="inputImage" class="image-display">
        
        <!-- Dropdowns for Image Input and Method Selection -->
        <div class="dropdown">
            <select id="imageInput" onchange="handleImageInputChange()">
                <option value="default">Use Default Image</option>
                <option value="camera">Take a Picture</option>
                <option value="upload">Select from Computer</option>
                <option value="ex1">Example Image 1</option>
                <option value="ex2">Example Image 2</option>
            </select>

            <select id="methodSelect">
                <option value="method1">Method 1</option>
                <option value="method2">Method 2</option>
                <option value="method3">Method 3</option>
            </select>
        </div>

        <!-- Button to Trigger API Call -->
        <button onclick="handleMethodChange()">Process Image</button>

        <!-- Section to Display Results -->
        <div id="result" class="result"></div>
    </div>

    <script>
        const apiUrl = "https://aashish75-attentionvisualisationvqa.hf.space/gradio_api/call/predict"; // Replace with your Hugging Face Space API endpoint
        const authToken = "Bearer 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";

        function handleImageInputChange() {
            const inputType = document.getElementById("imageInput").value;
            const inputImage = document.getElementById("inputImage");

            if (inputType === "default") {
                inputImage.src = "default-image.jpg";
            } else if (inputType === "ex1") {
                inputImage.src = "example1.jpg";
            } else if (inputType === "ex2") {
                inputImage.src = "example2.jpg";
            } else if (inputType === "upload") {
                const inputFile = document.createElement("input");
                inputFile.type = "file";
                inputFile.accept = "image/*";
                inputFile.onchange = (e) => {
                    const file = e.target.files[0];
                    inputImage.src = URL.createObjectURL(file);
                };
                inputFile.click();
            } else if (inputType === "camera") {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then((stream) => {
                            const video = document.createElement("video");
                            video.srcObject = stream;
                            video.play();

                            video.onloadeddata = () => {
                                const canvas = document.createElement("canvas");
                                canvas.width = video.videoWidth;
                                canvas.height = video.videoHeight;
                                const context = canvas.getContext("2d");
                                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                                inputImage.src = canvas.toDataURL("image/png");
                                stream.getTracks().forEach(track => track.stop());
                            };
                        });
                } else {
                    alert("Camera not supported on this device");
                }
            }
        }

        async function handleMethodChange() {
    const inputImage = document.getElementById("inputImage").src;
    const method = document.getElementById("methodSelect").value;

    try {
        // First POST request to get the event ID
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": authToken,
            },
            body: JSON.stringify({ data: [inputImage, method] }),
        });
        const data = await response.json();
        const eventId = data.event_id;

        // Display the event ID on the page
        document.getElementById("result").innerHTML = `
            <p><strong>Event ID:</strong> ${eventId}</p>
        `;

        // Second GET request to get the processed image URL
        const resultResponse = await fetch(`${apiUrl}/${eventId}`, {
            method: "GET",
            headers: {
                "Authorization": authToken,
            },
        });
        const resultData = await resultResponse.json();
        const processedImageUrl = resultData.processed_image_url;

        // Display the processed image URL and result image
        document.getElementById("result").innerHTML += `
            <p><strong>Processed Image URL:</strong> ${processedImageUrl}</p>
            <h2>Result:</h2>
            <img src="${processedImageUrl}" alt="Result Image" onerror="this.onerror=null; this.src='fallback-image.jpg'; document.getElementById('errorMessage').textContent='Unable to load the result image.';">
            <p id="errorMessage" class="error-message"></p>
        `;
    } catch (error) {
        console.error("Error:", error);
        document.getElementById("result").innerHTML = `
            <p class="error-message">An error occurred while processing the image.</p>
        `;
    }
}
    </script>
</body>
</html>
